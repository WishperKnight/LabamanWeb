<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipos Técnicos | Lab Track</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 512 512%22><path fill=%22%233b82f6%22 d=%22M352 320c-23.03 0-44.42 8.35-61.1 22.06l-67.9-20.94c4.6-11.41 7-23.59 7-36.12 0-53.02-42.98-96-96-96s-96 42.98-96 96 42.98 96 96 96c8.48 0 16.63-1.11 24.39-3.18l67.35 20.77C226.04 443.34 224 447.45 224 452c0 33.14 26.86 60 60 60h168c33.14 0 60-26.86 60-60v-72c0-33.14-26.86-60-60-60H352zM134 320c-18.78 0-34-15.22-34-34s15.22-34 34-34 34 15.22 34 34-15.22 34-34 34z%22/></svg>">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="sidebar-container"></div>

    <div class="main">
        <div class="container-fluid">
            <header class="d-flex justify-content-between align-items-center mb-5">
                <div>
                    <h2 class="fw-bold text-dark m-0">Gestión de Equipos</h2>
                    <p class="text-muted small m-0">Control de inventario técnico y trazabilidad de activos.</p>
                </div>
                <button class="btn btn-primary rounded-pill px-4 shadow-sm fw-bold" data-bs-toggle="modal" data-bs-target="#modalEquipo">
                    <i class="fas fa-plus me-2"></i>Registrar Nuevo Equipo
                </button>
            </header>

            <div class="card-premium border-0 shadow-sm">
                <div class="table-responsive">
                    <table class="table align-middle custom-table">
                        <thead class="text-muted small fw-bold">
                            <tr>
                                <th>EQUIPO / SERIAL</th>
                                <th>FABRICANTE / TIPO</th>
                                <th>LABORATORIO</th>
                                <th>ESTADO</th>
                                <th class="text-end">DETALLES</th>
                            </tr>
                        </thead>
                        <tbody id="lista-equipos">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEquipo" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 24px;">
                <div class="modal-header border-0 px-4 pt-4">
                    <h5 class="fw-bold m-0 text-primary"><i class="fas fa-file-medical me-2"></i>Ficha de Alta de Equipo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-equipo">
                    <div class="modal-body p-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Nombre / Modelo</label>
                                <input type="text" id="eq-nombre" class="form-control rounded-3 bg-light border-0" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Número de Serie (S/N)</label>
                                <input type="text" id="eq-serial" class="form-control rounded-3 bg-light border-0" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Fabricante</label>
                                <input type="text" id="eq-fabricante" class="form-control rounded-3 bg-light border-0" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Categoría Técnica</label>
                                <select id="eq-tipo" class="form-select rounded-3 bg-light border-0" required>
                                    <option value="Volumetría">Volumetría</option>
                                    <option value="Medición">Medición</option>
                                    <option value="Cromatografía">Cromatografía</option>
                                    <option value="Óptica">Óptica</option>
                                    <option value="Térmico">Térmico</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Estado Actual</label>
                                <select id="eq-estado" class="form-select rounded-3 bg-light border-0" required>
                                    <option value="Operativo">Operativo</option>
                                    <option value="En Mantenimiento">En Mantenimiento</option>
                                    <option value="Fuera de Servicio">Fuera de Servicio</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Laboratorio Asignado</label>
                                <select id="eq-lab" class="form-select select-labs rounded-3 bg-light border-0" required></select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">URL Documentación (Manual)</label>
                                <input type="url" id="eq-doc" class="form-control rounded-3 bg-light border-0" placeholder="https://...">
                            </div>
                            <div class="col-12">
                                <label class="form-label small fw-bold">Observaciones</label>
                                <textarea id="eq-obs" class="form-control rounded-3 bg-light border-0" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 p-4 pt-0">
                        <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-sm">Registrar Equipo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalDetalleEquipo" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 24px;">
                <div class="modal-header border-0 px-4 pt-4 bg-light" style="border-radius: 24px 24px 0 0;">
                    <h5 class="fw-bold m-0 text-primary">Vista Detallada del Activo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4 text-center">
                    <div class="icon-box-lg bg-primary-subtle text-primary mx-auto mb-3">
                        <i class="fas fa-microscope fa-2x"></i>
                    </div>
                    <h4 id="det-nombre" class="fw-bold mb-1">---</h4>
                    <span id="det-estado" class="badge rounded-pill px-3 mb-4">---</span>

                    <div class="row g-3 text-start">
                        <div class="col-6 bg-light p-3 rounded-3 border-white border">
                            <small class="text-muted d-block">S/N Serial</small>
                            <span id="det-serial" class="fw-bold text-dark">---</span>
                        </div>
                        <div class="col-6 bg-light p-3 rounded-3 border-white border">
                            <small class="text-muted d-block">Fabricante</small>
                            <span id="det-fabricante" class="fw-bold text-dark">---</span>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Categoría</small>
                            <p id="det-tipo" class="fw-bold m-0">---</p>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Laboratorio</small>
                            <p id="det-lab" class="fw-bold m-0">---</p>
                        </div>
                        <div class="col-12 mt-3">
                            <small class="text-muted">Observaciones Técnicas</small>
                            <p id="det-obs" class="small text-muted bg-light p-3 rounded-3 mt-1">---</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <a id="det-btn-doc" href="#" target="_blank" class="btn btn-outline-primary w-100 rounded-pill fw-bold">
                        <i class="fas fa-file-pdf me-2"></i>Manual de Usuario
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { cargarSidebar } from './sidebar.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        cargarSidebar('equipos');

        const firebaseConfig = { 
            apiKey: "AIzaSyA_aXLKh1HXcXGD1_s7mA7VuCPsSm1IBPA", 
            authDomain: "labmanager-b85b1.firebaseapp.com", 
            projectId: "labmanager-b85b1", 
            appId: "1:651630503448:web:9a327cbf30b84fd763c56d" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Lógica Detalle Global
        window.verDetalle = (n, s, f, t, est, l, d, o) => {
            document.getElementById('det-nombre').innerText = n;
            document.getElementById('det-serial').innerText = s;
            document.getElementById('det-fabricante').innerText = f;
            document.getElementById('det-tipo').innerText = t;
            document.getElementById('det-lab').innerText = l;
            document.getElementById('det-obs').innerText = o || "Sin observaciones registradas.";
            
            const badge = document.getElementById('det-estado');
            badge.innerText = est;
            badge.className = `badge rounded-pill px-3 ${est === 'Operativo' ? 'bg-success' : est === 'En Mantenimiento' ? 'bg-warning text-dark' : 'bg-danger'}`;

            const btn = document.getElementById('det-btn-doc');
            if (d && d !== "No adjunta") { btn.href = d; btn.classList.remove('d-none'); }
            else { btn.classList.add('d-none'); }

            new bootstrap.Modal(document.getElementById('modalDetalleEquipo')).show();
        };

        // Cargar Laboratorios
        onSnapshot(collection(db, "laboratorios"), (snap) => {
            const select = document.getElementById('eq-lab');
            select.innerHTML = '<option value="" disabled selected>Elegir laboratorio...</option>';
            snap.forEach(doc => select.innerHTML += `<option value="${doc.data().nombre}">${doc.data().nombre}</option>`);
        });

        // Cargar Tabla de Equipos
        onSnapshot(collection(db, "equipos"), (snap) => {
            const cont = document.getElementById('lista-equipos');
            cont.innerHTML = "";
            snap.forEach(doc => {
                const e = doc.data();
                const color = e.estado === 'Operativo' ? 'bg-success' : e.estado === 'En Mantenimiento' ? 'bg-warning text-dark' : 'bg-danger';
                
                cont.innerHTML += `
                    <tr>
                        <td>
                            <a href="javascript:void(0)" class="text-decoration-none" onclick="verDetalle('${e.nombre}','${e.serial}','${e.fabricante}','${e.tipo}','${e.estado}','${e.laboratorio}','${e.documentacion}','${e.observaciones}')">
                                <div class="fw-bold text-primary mb-0">${e.nombre}</div>
                                <div class="text-muted small">SN: ${e.serial}</div>
                            </a>
                        </td>
                        <td>
                            <div class="small fw-bold">${e.fabricante}</div>
                            <span class="badge bg-light text-dark border px-2" style="font-size: 0.65rem;">${e.tipo}</span>
                        </td>
                        <td><span class="text-muted small"><i class="fas fa-microscope me-1"></i>${e.laboratorio}</span></td>
                        <td><span class="badge ${color} rounded-pill px-3" style="font-size: 0.7rem;">${e.estado}</span></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-light rounded-circle shadow-sm" onclick="verDetalle('${e.nombre}','${e.serial}','${e.fabricante}','${e.tipo}','${e.estado}','${e.laboratorio}','${e.documentacion}','${e.observaciones}')">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </td>
                    </tr>`;
            });
        });

        // Guardar Nuevo
        document.getElementById('form-equipo').onsubmit = async (e) => {
            e.preventDefault();
            await addDoc(collection(db, "equipos"), {
                nombre: document.getElementById('eq-nombre').value,
                serial: document.getElementById('eq-serial').value,
                fabricante: document.getElementById('eq-fabricante').value,
                tipo: document.getElementById('eq-tipo').value,
                estado: document.getElementById('eq-estado').value,
                laboratorio: document.getElementById('eq-lab').value,
                documentacion: document.getElementById('eq-doc').value || "No adjunta",
                observaciones: document.getElementById('eq-obs').value,
                fecha: new Date().toISOString()
            });
            bootstrap.Modal.getInstance(document.getElementById('modalEquipo')).hide();
            document.getElementById('form-equipo').reset();
        };
    </script>
</body>
</html>