<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sedes y Laboratorios | Lab Track</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div id="sidebar-container"></div>

    <div class="main">
        <div class="container-fluid">
            <header class="d-flex justify-content-between align-items-center mb-5">
                <div>
                    <h2 class="fw-bold text-dark m-0">Sedes y Laboratorios</h2>
                    <p class="text-muted small m-0">Gestión de responsables, capacidad y activos.</p>
                </div>
                <button class="btn btn-primary rounded-pill px-4 shadow-sm fw-bold" onclick="abrirModalCrear()">
                    <i class="fas fa-plus me-2"></i>Nueva Sede
                </button>
            </header>

            <div class="row g-4" id="contenedor-laboratorios">
                </div>
        </div>
    </div>

    <div class="modal fade" id="modalLab" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 24px;">
                <div class="modal-header border-0 px-4 pt-4">
                    <h5 class="fw-bold m-0 text-primary" id="modal-titulo">Registrar Unidad</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-lab">
                    <input type="hidden" id="lab-id">
                    <div class="modal-body p-4">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Nombre del Laboratorio</label>
                            <input type="text" id="lab-nombre" class="form-control rounded-3 bg-light border-0" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Responsable / Encargado (Supervisor)</label>
                            <select id="lab-responsable" class="form-select rounded-3 bg-light border-0" required>
                                <option value="" disabled selected>Cargando supervisores...</option>
                            </select>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label small fw-bold">Ubicación</label>
                                <input type="text" id="lab-ubicacion" class="form-control rounded-3 bg-light border-0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label small fw-bold">Capacidad Máx.</label>
                                <input type="number" id="lab-capacidad" class="form-control rounded-3 bg-light border-0" required>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 p-4 pt-0">
                        <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-sm">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalVerEquipos" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 24px;">
                <div class="modal-header border-0 px-4 pt-4">
                    <h5 class="fw-bold m-0" id="modal-lab-titulo">Inventario de Sede</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table class="table align-middle mb-0">
                            <thead class="bg-light small">
                                <tr>
                                    <th class="ps-4">EQUIPO</th>
                                    <th>ESTADO</th>
                                    <th class="pe-4 text-end">SERIAL</th>
                                </tr>
                            </thead>
                            <tbody id="lista-equipos-lab"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { cargarSidebar } from './sidebar.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        cargarSidebar('laboratorios');

        const firebaseConfig = {
            apiKey: "AIzaSyA_aXLKh1HXcXGD1_s7mA7VuCPsSm1IBPA",
            authDomain: "labmanager-b85b1.firebaseapp.com",
            projectId: "labmanager-b85b1",
            appId: "1:651630503448:web:9a327cbf30b84fd763c56d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- CARGAR SUPERVISORES EN EL SELECT ---
        const cargarSupervisores = async () => {
            const selectResp = document.getElementById('lab-responsable');
            try {
                const q = query(collection(db, "usuarios"), where("rol", "==", "Supervisor"));
                const snap = await getDocs(q);
                
                selectResp.innerHTML = '<option value="" disabled selected>Seleccione un supervisor...</option>';
                
                snap.forEach(d => {
                    const user = d.data();
                    const option = document.createElement('option');
                    option.value = user.nombre;
                    option.textContent = user.nombre;
                    selectResp.appendChild(option);
                });
            } catch (error) {
                console.error("Error cargando supervisores:", error);
                selectResp.innerHTML = '<option value="">Error al cargar supervisores</option>';
            }
        };

        // --- FUNCIONES DE MODAL ---
        window.abrirModalCrear = async () => {
            document.getElementById('form-lab').reset();
            document.getElementById('lab-id').value = "";
            document.getElementById('modal-titulo').innerText = "Registrar Nueva Unidad";
            await cargarSupervisores();
            new bootstrap.Modal(document.getElementById('modalLab')).show();
        };

        window.abrirModalEditar = async (id, nombre, responsableActual, ubicacion, capacidad) => {
            document.getElementById('lab-id').value = id;
            document.getElementById('lab-nombre').value = nombre;
            document.getElementById('lab-ubicacion').value = ubicacion;
            document.getElementById('lab-capacidad').value = capacidad;
            document.getElementById('modal-titulo').innerText = "Modificar Laboratorio";
            
            await cargarSupervisores();
            // Selecciona el responsable actual en el spinner
            document.getElementById('lab-responsable').value = responsableActual;
            
            new bootstrap.Modal(document.getElementById('modalLab')).show();
        };

        window.eliminarLaboratorio = async (id, nombre) => {
            if (confirm(`¿Estás seguro de que deseas eliminar "${nombre}"? Esta acción borrará la sede permanentemente.`)) {
                try {
                    await deleteDoc(doc(db, "laboratorios", id));
                } catch (err) {
                    alert("Error: " + err.message);
                }
            }
        };

        window.verEquiposDelLab = async (nombreLab) => {
            document.getElementById('modal-lab-titulo').innerText = `Inventario: ${nombreLab}`;
            const cont = document.getElementById('lista-equipos-lab');
            cont.innerHTML = `<tr><td colspan="3" class="text-center p-4">Cargando activos...</td></tr>`;
            new bootstrap.Modal(document.getElementById('modalVerEquipos')).show();

            const q = query(collection(db, "equipos"), where("laboratorio", "==", nombreLab));
            const snap = await getDocs(q);
            cont.innerHTML = snap.empty ? `<tr><td colspan="3" class="text-center p-4">No hay equipos registrados.</td></tr>` : "";
            snap.forEach(d => {
                const e = d.data();
                cont.innerHTML += `<tr><td class="ps-4"><b>${e.nombre}</b></td><td><span class="badge bg-light text-dark border">${e.estado}</span></td><td class="pe-4 text-end small text-muted">${e.serial || 'S/N'}</td></tr>`;
            });
        };

        // --- RENDERIZADO EN TIEMPO REAL ---
        onSnapshot(collection(db, "laboratorios"), (snap) => {
            const cont = document.getElementById('contenedor-laboratorios');
            cont.innerHTML = "";

            snap.forEach(async (d) => {
                const lab = d.data();
                const id = d.id;
                const responsable = lab.responsable || "Sin asignar";
                
                const col = document.createElement('div');
                col.className = "col-md-6 col-xl-4";
                col.innerHTML = `
                    <div class="card-premium border-0 shadow-sm p-4 h-100">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="icon-box-lg bg-primary-subtle text-primary"><i class="fas fa-building"></i></div>
                            <div class="d-flex gap-2">
                                <button onclick="abrirModalEditar('${id}','${lab.nombre}','${responsable}','${lab.ubicacion}','${lab.capacidad}')" class="btn btn-sm btn-light rounded-circle shadow-sm">
                                    <i class="fas fa-pen text-primary" style="font-size: 0.8rem;"></i>
                                </button>
                                <button onclick="eliminarLaboratorio('${id}','${lab.nombre}')" class="btn btn-sm btn-light rounded-circle shadow-sm">
                                    <i class="fas fa-trash text-danger" style="font-size: 0.8rem;"></i>
                                </button>
                            </div>
                        </div>
                        <h5 class="fw-bold mb-1 text-dark">${lab.nombre}</h5>
                        <p class="text-muted small mb-3"><i class="fas fa-user-shield me-1 text-primary"></i> Resp: <b>${responsable}</b></p>
                        
                        <div class="bg-light rounded-4 p-3 d-flex justify-content-around mb-4 border border-white">
                            <div class="text-center">
                                <span class="d-block h5 fw-bold mb-0 text-primary" id="count-${id}">...</span>
                                <small class="text-muted fw-bold" style="font-size:0.6rem">EQUIPOS</small>
                            </div>
                            <div class="vr opacity-25"></div>
                            <div class="text-center">
                                <span class="d-block h5 fw-bold mb-0 text-dark">${lab.capacidad}</span>
                                <small class="text-muted fw-bold" style="font-size:0.6rem">CUPO MÁX</small>
                            </div>
                        </div>
                        <button onclick="verEquiposDelLab('${lab.nombre}')" class="btn btn-primary w-100 rounded-pill fw-bold btn-sm py-2 shadow-sm">
                            <i class="fas fa-list-ul me-2"></i>Ver Inventario
                        </button>
                    </div>`;
                cont.appendChild(col);

                // Contador de equipos dinámico
                const qE = query(collection(db, "equipos"), where("laboratorio", "==", lab.nombre));
                const snapE = await getDocs(qE);
                const el = document.getElementById(`count-${id}`);
                if(el) el.innerText = snapE.size;
            });
        });

        // --- GUARDAR O ACTUALIZAR ---
        document.getElementById('form-lab').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('lab-id').value;
            const datos = {
                nombre: document.getElementById('lab-nombre').value,
                responsable: document.getElementById('lab-responsable').value,
                ubicacion: document.getElementById('lab-ubicacion').value,
                capacidad: document.getElementById('lab-capacidad').value
            };

            try {
                if (id) {
                    await updateDoc(doc(db, "laboratorios", id), datos);
                } else {
                    await addDoc(collection(db, "laboratorios"), { ...datos, fecha: new Date().toISOString() });
                }
                bootstrap.Modal.getInstance(document.getElementById('modalLab')).hide();
            } catch (err) {
                alert("Error al guardar: " + err.message);
            }
        };
    </script>
</body>
</html>