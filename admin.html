<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios | Lab Track</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
        <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 512 512%22><path fill=%22%233b82f6%22 d=%22M352 320c-23.03 0-44.42 8.35-61.1 22.06l-67.9-20.94c4.6-11.41 7-23.59 7-36.12 0-53.02-42.98-96-96-96s-96 42.98-96 96 42.98 96 96 96c8.48 0 16.63-1.11 24.39-3.18l67.35 20.77C226.04 443.34 224 447.45 224 452c0 33.14 26.86 60 60 60h168c33.14 0 60-26.86 60-60v-72c0-33.14-26.86-60-60-60H352zM134 320c-18.78 0-34-15.22-34-34s15.22-34 34-34 34 15.22 34 34-15.22 34-34 34z%22/></svg>">

</head>
<body class="bg-light">

    <div id="sidebar-container"></div>

    <div class="main">
        <div class="container-fluid">
            <header class="mb-5 mt-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="fw-bold text-dark m-0">Administración de Usuarios</h2>
                        <p class="text-muted small m-0">Gestión privada de tu personal y colaboradores.</p>
                    </div>
                    <button class="btn btn-primary rounded-pill px-4 shadow-sm fw-bold" onclick="abrirModalNuevoUsuario()">
                        <i class="fas fa-user-plus me-2"></i>Añadir Usuario
                    </button>
                </div>

                <div class="row g-3 bg-white p-3 rounded-4 shadow-sm border">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text bg-light border-0"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" id="busqueda-usuario" class="form-control bg-light border-0" placeholder="Buscar en mi equipo...">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select id="filtro-rol" class="form-select bg-light border-0">
                            <option value="todos">Todos los roles</option>
                            <option value="Supervisor">Supervisor</option>
                            <option value="tecnico">Técnico</option>
                            <option value="usuario">Usuario</option>
                        </select>
                    </div>
                </div>
            </header>

            <div class="card-premium border-0 shadow-sm bg-white rounded-4 overflow-hidden">
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead class="bg-light text-muted small fw-bold text-uppercase">
                            <tr>
                                <th class="ps-4">Usuario</th>
                                <th>Rol</th>
                                <th>Laboratorio Asignado</th>
                                <th class="text-end pe-4">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="lista-usuarios"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalNuevoUsuario" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 px-4 pt-4">
                    <h5 class="fw-bold m-0 text-success">Registrar Nuevo Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-nuevo-usuario">
                    <div class="modal-body p-4">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Nombre Completo</label>
                            <input type="text" id="nuevo-nombre" class="form-control bg-light border-0 rounded-3" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Correo Electrónico</label>
                            <input type="email" id="nuevo-email" class="form-control bg-light border-0 rounded-3" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Asignar Rol</label>
                            <select id="nuevo-rol" class="form-select bg-light border-0 rounded-3" required>
                                <option value="usuario">Usuario (Consulta)</option>
                                <option value="tecnico">Técnico (Inventario)</option>
                                <option value="Supervisor">Supervisor (Full)</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer border-0 p-4 pt-0">
                        <button type="submit" class="btn btn-success w-100 rounded-pill py-2 fw-bold shadow-sm">Crear Usuario</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalRol" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 px-4 pt-4">
                    <h5 class="fw-bold m-0 text-primary">Modificar Permisos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" id="user-id-rol">
                    <p class="small text-muted mb-4">Nuevo nivel de acceso para <b id="user-nombre-rol"></b>:</p>
                    <select id="select-nuevo-rol" class="form-select form-select-lg border-0 bg-light rounded-4">
                        <option value="Supervisor">Supervisor</option>
                        <option value="tecnico">Técnico</option>
                        <option value="usuario">Usuario</option>
                    </select>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button onclick="guardarNuevoRol()" class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-sm">Actualizar Rol</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { cargarSidebar } from './sidebar.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, addDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        cargarSidebar('usuarios');

        const firebaseConfig = { apiKey: "AIzaSyA_aXLKh1HXcXGD1_s7mA7VuCPsSm1IBPA", authDomain: "labmanager-b85b1.firebaseapp.com", projectId: "labmanager-b85b1", appId: "1:651630503448:web:9a327cbf30b84fd763c56d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentAdminId = null;
        let todosLosUsuarios = [];
        let listaLaboratorios = [];

        // --- RESTRICCIÓN ATÓMICA: VERIFICAR SESIÓN Y CARGAR ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentAdminId = user.uid;
                iniciarListeners();
            } else {
                window.location.href = 'login.html';
            }
        });

        function iniciarListeners() {
            // 1. ESCUCHAR SOLO MIS LABORATORIOS
            const qLabs = query(collection(db, "laboratorios"), where("adminId", "==", currentAdminId));
            onSnapshot(qLabs, (snap) => {
                listaLaboratorios = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                aplicarFiltros();
            });

            // 2. ESCUCHAR SOLO MIS USUARIOS
            const qUsers = query(collection(db, "usuarios"), where("adminId", "==", currentAdminId));
            onSnapshot(qUsers, (snap) => {
                todosLosUsuarios = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                aplicarFiltros();
            });
        }

        const aplicarFiltros = () => {
            const texto = document.getElementById('busqueda-usuario').value.toLowerCase();
            const rolSeleccionado = document.getElementById('filtro-rol').value;
            const filtrados = todosLosUsuarios.filter(u => {
                const coincideTexto = (u.nombre || "").toLowerCase().includes(texto) || (u.email || "").toLowerCase().includes(texto);
                const coincideRol = rolSeleccionado === "todos" || u.rol === rolSeleccionado;
                return coincideTexto && coincideRol;
            });
            renderizarTabla(filtrados);
        };

        const renderizarTabla = (usuarios) => {
            const cont = document.getElementById('lista-usuarios');
            cont.innerHTML = "";
            usuarios.forEach(u => {
                const rolColor = u.rol === 'Supervisor' ? 'bg-danger' : (u.rol === 'tecnico' ? 'bg-primary' : 'bg-secondary');
                
                let selectLabs = `<select class="form-select form-select-sm border-0 bg-light rounded-3" onchange="asignarLab('${u.id}', this.value)">
                                    <option value="">Sin asignar</option>`;
                listaLaboratorios.forEach(lab => {
                    const selected = u.laboratorioId === lab.id ? 'selected' : '';
                    selectLabs += `<option value="${lab.id}" ${selected}>${lab.nombre}</option>`;
                });
                selectLabs += `</select>`;

                cont.innerHTML += `
                    <tr>
                        <td class="ps-4">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                    <i class="fas fa-user text-muted"></i>
                                </div>
                                <div>
                                    <div class="fw-bold text-dark">${u.nombre || 'Sin nombre'}</div>
                                    <div class="text-muted small">${u.email}</div>
                                </div>
                            </div>
                        </td>
                        <td><span class="badge ${rolColor}-subtle ${rolColor.replace('bg-', 'text-')} rounded-pill px-3">${(u.rol || 'usuario').toUpperCase()}</span></td>
                        <td>${selectLabs}</td>
                        <td class="text-end pe-4">
                            <button onclick="prepararCambioRol('${u.id}', '${u.nombre}', '${u.rol}')" class="btn btn-sm btn-light rounded-circle text-primary me-2 shadow-sm"><i class="fas fa-user-shield"></i></button>
                            <button onclick="eliminarUsuario('${u.id}', '${u.nombre}')" class="btn btn-sm btn-light rounded-circle text-danger shadow-sm"><i class="fas fa-user-minus"></i></button>
                        </td>
                    </tr>`;
            });
        };

        // --- FUNCIONES GLOBALES CON RESTRICCIÓN ---
        window.asignarLab = async (userId, labId) => {
            try {
                await updateDoc(doc(db, "usuarios", userId), { laboratorioId: labId });
            } catch (e) { console.error(e); }
        };

        window.abrirModalNuevoUsuario = () => {
            document.getElementById('form-nuevo-usuario').reset();
            new bootstrap.Modal(document.getElementById('modalNuevoUsuario')).show();
        };

        document.getElementById('form-nuevo-usuario').onsubmit = async (e) => {
            e.preventDefault();
            if(!currentAdminId) return;

            await addDoc(collection(db, "usuarios"), {
                nombre: document.getElementById('nuevo-nombre').value,
                email: document.getElementById('nuevo-email').value,
                rol: document.getElementById('nuevo-rol').value,
                laboratorioId: "",
                adminId: currentAdminId, // <--- RESTRICCIÓN ATÓMICA: El dueño
                fechaCreacion: new Date().toISOString()
            });
            bootstrap.Modal.getInstance(document.getElementById('modalNuevoUsuario')).hide();
        };

        window.prepararCambioRol = (id, nombre, rolActual) => {
            document.getElementById('user-id-rol').value = id;
            document.getElementById('user-nombre-rol').innerText = nombre;
            document.getElementById('select-nuevo-rol').value = rolActual;
            new bootstrap.Modal(document.getElementById('modalRol')).show();
        };

        window.guardarNuevoRol = async () => {
            await updateDoc(doc(db, "usuarios", document.getElementById('user-id-rol').value), {
                rol: document.getElementById('select-nuevo-rol').value
            });
            bootstrap.Modal.getInstance(document.getElementById('modalRol')).hide();
        };

        window.eliminarUsuario = async (id, nombre) => {
            if (confirm(`¿Eliminar a ${nombre}?`)) await deleteDoc(doc(db, "usuarios", id));
        };

        document.getElementById('busqueda-usuario').oninput = aplicarFiltros;
        document.getElementById('filtro-rol').onchange = aplicarFiltros;
    </script>
</body>
</html>