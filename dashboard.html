<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Lab Track</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 512 512%22><path fill=%22%233b82f6%22 d=%22M352 320c-23.03 0-44.42 8.35-61.1 22.06l-67.9-20.94c4.6-11.41 7-23.59 7-36.12 0-53.02-42.98-96-96-96s-96 42.98-96 96 42.98 96 96 96c8.48 0 16.63-1.11 24.39-3.18l67.35 20.77C226.04 443.34 224 447.45 224 452c0 33.14 26.86 60 60 60h168c33.14 0 60-26.86 60-60v-72c0-33.14-26.86-60-60-60H352zM134 320c-18.78 0-34-15.22-34-34s15.22-34 34-34 34 15.22 34 34-15.22 34-34 34z%22/></svg>">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-light">

    <div id="sidebar-container"></div>

    <div class="main">
        <div class="container-fluid">
            <header class="d-flex justify-content-between align-items-center mb-5 mt-4">
                <div>
                    <h2 class="fw-bold text-dark m-0">Panel de Control</h2>
                    <p class="text-muted small m-0">Gestión centralizada de activos y personal.</p>
                </div>
                <div class="bg-white px-3 py-2 rounded-3 shadow-sm fw-bold border">
                    <i class="far fa-calendar-alt me-2 text-primary"></i> <span id="fecha-actual"></span>
                </div>
            </header>

            <div class="row mb-5">
                <div class="col-12">
                    <div class="card-premium border-0 shadow-sm bg-white rounded-4 p-4 border-start border-primary border-4">
                        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                            <div>
                                <h6 class="fw-bold m-0"><i class="fas fa-file-export me-2 text-primary"></i>Plantillas de Importación</h6>
                                <p class="text-muted small mb-0">Descarga el formato CSV para carga masiva.</p>
                            </div>
                            <div class="d-flex gap-2">
                                <button id="btn-p-reactivos" class="btn btn-primary rounded-pill px-3 shadow-sm btn-sm">
                                    <i class="fas fa-flask me-2"></i>Reactivos
                                </button>
                                <button id="btn-p-fungibles" class="btn btn-info text-white rounded-pill px-3 shadow-sm btn-sm">
                                    <i class="fas fa-box me-2"></i>Fungibles
                                </button>
                                <button id="btn-p-equipos" class="btn btn-dark rounded-pill px-3 shadow-sm btn-sm">
                                    <i class="fas fa-microscope me-2"></i>Equipos
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-5">
                <div class="col-6 col-lg-3">
                    <div class="stat-card-premium card-blue">
                        <div class="icon-box"><i class="fas fa-hospital"></i></div>
                        <div><h2 id="count-labs" class="fw-bold mb-0">0</h2><small class="text-muted fw-bold">SEDES</small></div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="stat-card-premium card-green">
                        <div class="icon-box"><i class="fas fa-vials"></i></div>
                        <div><h2 id="count-materiales" class="fw-bold mb-0">0</h2><small class="text-muted fw-bold">ARTÍCULOS</small></div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="stat-card-premium card-red">
                        <div class="icon-box"><i class="fas fa-exclamation-circle"></i></div>
                        <div><h2 id="count-incidencias" class="fw-bold mb-0">0</h2><small class="text-muted fw-bold">INCIDENCIAS</small></div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="stat-card-premium card-dark">
                        <div class="icon-box"><i class="fas fa-user-md"></i></div>
                        <div><h2 id="count-users" class="fw-bold mb-0">0</h2><small class="text-muted fw-bold">PERSONAL</small></div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-5">
                <div class="col-lg-8">
                    <div class="card-premium h-100 shadow-sm border-0 bg-white p-4 rounded-4">
                        <h6 class="fw-bold mb-4"><i class="fas fa-map-marker-alt me-2 text-primary"></i>Estado de Laboratorios</h6>
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead class="text-muted small">
                                    <tr>
                                        <th>NOMBRE</th>
                                        <th>UBICACIÓN</th>
                                        <th>PERSONAL ASIGNADO</th>
                                        <th class="text-end">ESTADO</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-labs">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card-premium h-100 shadow-sm border-0 bg-white p-4 rounded-4">
                        <h6 class="fw-bold mb-4 text-danger"><i class="fas fa-bell me-2"></i>Alertas Críticas</h6>
                        <div id="contenedor-alertas">
                            <div class="text-center py-5 text-muted small">Cargando alertas...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { cargarSidebar } from './sidebar.js';
        import { descargarCSV } from './exportador-csv.js'; 
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        cargarSidebar('dashboard');

        const firebaseConfig = { 
            apiKey: "AIzaSyA_aXLKh1HXcXGD1_s7mA7VuCPsSm1IBPA", 
            authDomain: "labmanager-b85b1.firebaseapp.com", 
            projectId: "labmanager-b85b1", 
            appId: "1:651630503448:web:9a327cbf30b84fd763c56d" 
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Fecha Actual
        document.getElementById('fecha-actual').innerText = new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });

        // --- MANEJO DE DATOS CRUZADOS (USUARIOS + LABS) ---
        let usuariosGlobales = [];
        let labsGlobales = [];

        function renderizarTablaLabs() {
            const tb = document.getElementById('tabla-labs');
            tb.innerHTML = "";
            
            labsGlobales.forEach(lab => {
                // Filtramos usuarios que pertenezcan a este lab
                const tecnicosEnLab = usuariosGlobales.filter(u => u.laboratorioId === lab.id).length;
                const textoTecnicos = tecnicosEnLab === 1 ? "1 Especialista" : `${tecnicosEnLab} Especialistas`;

                tb.innerHTML += `
                    <tr>
                        <td><div class="fw-bold text-dark">${lab.nombre}</div></td>
                        <td><span class="text-muted small"><i class="fas fa-location-dot me-1"></i>${lab.ubicacion || 'N/A'}</span></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="badge bg-light text-primary border me-2"><i class="fas fa-users-cog"></i></div>
                                <span class="small fw-bold">${textoTecnicos}</span>
                            </div>
                        </td>
                        <td class="text-end">
                            <span class="badge bg-success-subtle text-success border-0 px-3 rounded-pill">Activo</span>
                        </td>
                    </tr>`;
            });
        }

        // Listeners Realtime
        onSnapshot(collection(db, "usuarios"), snap => {
            usuariosGlobales = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            document.getElementById('count-users').innerText = snap.size;
            renderizarTablaLabs();
        });

        onSnapshot(collection(db, "laboratorios"), snap => {
            labsGlobales = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            document.getElementById('count-labs').innerText = snap.size;
            renderizarTablaLabs();
        });

        onSnapshot(collection(db, "inventario"), snap => {
            document.getElementById('count-materiales').innerText = snap.size;
            const alertaCont = document.getElementById('contenedor-alertas');
            let alertasHTML = "";
            
            snap.forEach(doc => {
                const m = doc.data();
                // Alerta si el stock es bajo (menos de 5 unidades)
                if(Number(m.cantidad_unidades) < 5) {
                    alertasHTML += `
                        <div class="alert alert-warning border-0 shadow-sm rounded-4 mb-2 py-2 px-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="small fw-bold text-dark">${m.nombre}</span>
                                <span class="badge bg-danger rounded-pill">${m.cantidad_unidades} uds</span>
                            </div>
                        </div>`;
                }
            });
            alertaCont.innerHTML = alertasHTML || '<div class="text-center py-5 text-muted small">No hay alertas de stock.</div>';
        });

        onSnapshot(collection(db, "incidencias"), s => document.getElementById('count-incidencias').innerText = s.size);

        // --- BOTONES DE PLANTILLAS ---
        document.getElementById('btn-p-reactivos').onclick = () => {
            descargarCSV([{"Nombre": "Ej: Etanol", "Fabricante": "Panreac", "Cantidad": "1", "Caducidad": "2026-01-01", "Lote": "L123", "Molaridad": "1M", "Riqueza": "99%", "Stock": "10", "Tipo": "reactivo"}], "Plantilla_Reactivos");
        };
        document.getElementById('btn-p-fungibles').onclick = () => {
            descargarCSV([{"Nombre": "Ej: Guantes", "Marca": "Deltalab", "Unidades": "100", "Capacidad": "M", "Lote": "L99", "Fecha de caducidad": "2030-01-01", "Tipo": "fungible"}], "Plantilla_Fungibles");
        };
    </script>
</body>
</html>